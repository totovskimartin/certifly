{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/alerts.css') }}">
{% endblock %}

{% block content %}
<div class="container py-2">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="h3 fw-bold mb-1">Alerts</h1>
            <p class="text-muted small mb-0">View all system alerts and notifications</p>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {% if category == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Alerts Card -->
    <div class="modern-card">
        <div class="modern-card-header">
            <div class="d-flex align-items-center">
                <h2 class="modern-card-title mb-0">
                    <i class="bi bi-bell"></i>
                    System Alerts
                </h2>
                <div class="dropdown ms-3">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="alertFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="alertFilterDropdown">
                        <li><a class="dropdown-item active" href="#" data-filter="all">All Alerts</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="unacknowledged">Unacknowledged</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="acknowledged">Acknowledged</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-filter="ssl">SSL Certificate</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="domain">Domain Expiry</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="ping">Ping Status</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="error">Errors</a></li>
                    </ul>
                </div>
            </div>
            <div class="header-actions">
                <!-- Acknowledge All button will be added here by JavaScript -->
            </div>
        </div>
        <div class="modern-card-body">
            <div class="alert-timeline">
                {% if alerts %}
                    <!-- Unacknowledged Alerts Section -->
                    {% set has_unacknowledged = false %}
                    <div class="alert-section mb-3" id="unacknowledged-alerts-section">
                        <h3 class="alert-section-title mb-2">
                            <i class="bi bi-bell-fill text-danger me-2"></i>
                            Unacknowledged Alerts
                            <span class="badge bg-danger ms-2" id="unacknowledged-count">0</span>
                        </h3>

                        {% for alert in alerts %}
                            {% if not alert.acknowledged %}
                                {% set has_unacknowledged = true %}
                                <div class="timeline-item" data-alert-type="{{ alert.type|lower }}">
                                    <div class="timeline-icon {{ alert.type|lower }}">
                                        <i class="bi bi-{{ alert.icon }}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <p class="timeline-text mb-0">{{ alert.message }}</p>
                                        </div>
                                        <div class="timeline-meta">
                                            <span class="timeline-time">{{ alert.time }}</span>
                                            <span class="timeline-domain">{{ alert.domain }}</span>
                                        </div>
                                    </div>
                                    <div class="timeline-actions">
                                        <form action="{{ url_for('acknowledge_alert', alert_id=alert.id) }}" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Acknowledge">
                                                <i class="bi bi-check-circle"></i> Acknowledge
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Acknowledged Alerts Section -->
                    {% set has_acknowledged = false %}
                    <div class="alert-section" id="acknowledged-alerts-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="alert-section-title mb-0">
                                <i class="bi bi-bell-check text-secondary me-2"></i>
                                Acknowledged Alerts
                                <span class="badge bg-secondary ms-2" id="acknowledged-count">0</span>
                            </h3>
                            <form action="{{ url_for('delete_all_acknowledged_alerts') }}" method="POST" class="d-inline" id="delete-all-form">
                                <button type="button" class="btn btn-sm btn-outline-danger" id="delete-all-btn">
                                    <i class="bi bi-trash me-1"></i> Delete All
                                </button>
                            </form>
                        </div>

                        {% for alert in alerts %}
                            {% if alert.acknowledged %}
                                {% set has_acknowledged = true %}
                                <div class="timeline-item acknowledged" data-alert-type="{{ alert.type|lower }}">
                                    <div class="timeline-icon {{ alert.type|lower }}">
                                        <i class="bi bi-{{ alert.icon }}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <p class="timeline-text mb-0">{{ alert.message }}</p>
                                        </div>
                                        <div class="timeline-meta">
                                            <span class="timeline-time">{{ alert.time }}</span>
                                            <span class="timeline-domain">{{ alert.domain }}</span>
                                            <span class="badge bg-secondary">Acknowledged</span>
                                        </div>
                                    </div>
                                    <div class="timeline-actions">
                                        <div class="btn-group">
                                            <form action="{{ url_for('unacknowledge_alert', alert_id=alert.id) }}" method="POST" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary" title="Remove acknowledgment">
                                                    <i class="bi bi-x-circle"></i> Unacknowledge
                                                </button>
                                            </form>
                                            <form action="{{ url_for('delete_alert', alert_id=alert.id) }}" method="POST" class="d-inline ms-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-alert-btn" title="Delete alert" data-alert-id="{{ alert.id }}">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <script>
                        // Update the counts and hide empty sections
                        document.addEventListener('DOMContentLoaded', function() {
                            const unacknowledgedItems = document.querySelectorAll('#unacknowledged-alerts-section .timeline-item').length;
                            const acknowledgedItems = document.querySelectorAll('#acknowledged-alerts-section .timeline-item').length;

                            document.getElementById('unacknowledged-count').textContent = unacknowledgedItems;
                            document.getElementById('acknowledged-count').textContent = acknowledgedItems;

                            if (unacknowledgedItems === 0) {
                                document.getElementById('unacknowledged-alerts-section').style.display = 'none';
                            }

                            if (acknowledgedItems === 0) {
                                document.getElementById('acknowledged-alerts-section').style.display = 'none';
                            }

                            // Handle individual alert deletion
                            const deleteButtons = document.querySelectorAll('.delete-alert-btn');
                            deleteButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    const alertId = this.getAttribute('data-alert-id');
                                    if (confirm('Are you sure you want to delete this alert? This action cannot be undone.')) {
                                        this.closest('form').submit();
                                    }
                                });
                            });

                            // Handle delete all acknowledged alerts
                            const deleteAllBtn = document.getElementById('delete-all-btn');
                            if (deleteAllBtn) {
                                deleteAllBtn.addEventListener('click', function() {
                                    if (acknowledgedItems === 0) {
                                        alert('There are no acknowledged alerts to delete.');
                                        return;
                                    }

                                    if (confirm(`Are you sure you want to delete all ${acknowledgedItems} acknowledged alerts? This action cannot be undone.`)) {
                                        document.getElementById('delete-all-form').submit();
                                    }
                                });
                            }

                            // Restore deleted alerts functionality removed
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No alerts to display. All systems are operating normally.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Alert filtering functionality
        const filterLinks = document.querySelectorAll('[data-filter]');
        const alertItems = document.querySelectorAll('.timeline-item');
        const alertSections = document.querySelectorAll('.alert-section');

        filterLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // Update active state
                filterLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const filterValue = this.getAttribute('data-filter');

                // Show/hide alerts based on filter
                alertItems.forEach(item => {
                    const isAcknowledged = item.classList.contains('acknowledged');
                    const alertType = item.getAttribute('data-alert-type');

                    let shouldShow = false;

                    if (filterValue === 'all') {
                        shouldShow = true;
                    } else if (filterValue === 'acknowledged') {
                        shouldShow = isAcknowledged;
                    } else if (filterValue === 'unacknowledged') {
                        shouldShow = !isAcknowledged;
                    } else {
                        shouldShow = alertType === filterValue;
                    }

                    item.style.display = shouldShow ? '' : 'none';
                });

                // Show/hide sections based on visible alerts
                alertSections.forEach(section => {
                    const visibleAlertsInSection = section.querySelectorAll('.timeline-item:not([style*="display: none"])');
                    if (visibleAlertsInSection.length > 0) {
                        section.style.display = '';
                        // Update the count badge
                        const countBadge = section.querySelector('.badge');
                        if (countBadge) {
                            countBadge.textContent = visibleAlertsInSection.length;
                        }
                    } else {
                        section.style.display = 'none';
                    }
                });

                // Show message if no alerts match filter
                const visibleAlerts = Array.from(alertItems).filter(item => item.style.display !== 'none');
                let noAlertsMessage = document.querySelector('.alert-info');
                const noFilterMatchMessage = document.querySelector('.no-filter-match');

                if (visibleAlerts.length === 0) {
                    if (noAlertsMessage) {
                        noAlertsMessage.style.display = 'none';
                    }

                    if (!noFilterMatchMessage) {
                        const message = document.createElement('div');
                        message.className = 'alert alert-info mt-3 no-filter-match';
                        message.innerHTML = '<i class="bi bi-info-circle me-2"></i> No alerts match the selected filter.';
                        document.querySelector('.alert-timeline').appendChild(message);
                    } else {
                        noFilterMatchMessage.style.display = '';
                    }
                } else {
                    if (noFilterMatchMessage) {
                        noFilterMatchMessage.style.display = 'none';
                    }
                }
            });
        });

        // Add button to acknowledge all visible alerts
        const headerActions = document.querySelector('.header-actions');
        if (headerActions && document.querySelectorAll('.timeline-item:not(.acknowledged)').length > 0) {
            const acknowledgeAllBtn = document.createElement('button');
            acknowledgeAllBtn.className = 'btn btn-sm btn-outline-primary';
            acknowledgeAllBtn.innerHTML = '<i class="bi bi-check-all"></i> Acknowledge All';
            acknowledgeAllBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to acknowledge all visible alerts?')) {
                    // Submit all visible unacknowledged alerts
                    const visibleUnacknowledgedAlerts = document.querySelectorAll('#unacknowledged-alerts-section .timeline-item:not([style*="display: none"])');
                    if (visibleUnacknowledgedAlerts.length > 0) {
                        // Create a form to submit all at once
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '{{ url_for("acknowledge_all_alerts") }}';

                        // Add all visible alert IDs as hidden inputs
                        visibleUnacknowledgedAlerts.forEach(alert => {
                            const acknowledgeBtn = alert.querySelector('form[action*="acknowledge_alert"] button');
                            if (acknowledgeBtn) {
                                const alertId = acknowledgeBtn.closest('form').action.split('/').pop();
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'alert_ids';
                                input.value = alertId;
                                form.appendChild(input);
                            }
                        });

                        document.body.appendChild(form);
                        form.submit();
                    }
                }
            });
            headerActions.appendChild(acknowledgeAllBtn);
        }
    });
</script>
{% endblock %}
