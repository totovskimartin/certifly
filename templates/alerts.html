{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/alerts.css') }}">
<style>
    /* Bulk operations styles */
    .timeline-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }

    .timeline-item {
        display: flex;
        align-items: flex-start;
    }

    .bulk-actions {
        display: flex;
        align-items: center;
    }

    @media (max-width: 768px) {
        .bulk-actions {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .bulk-actions .btn {
            margin-left: 0 !important;
            margin-top: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-2">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="h3 fw-bold mb-1">Alerts</h1>
            <p class="text-muted small mb-0">View all system alerts and notifications</p>
        </div>
    </div>



    <!-- Alerts Card -->
    <div class="modern-card">
        <div class="modern-card-header">
            <div class="d-flex align-items-center">
                <h2 class="modern-card-title mb-0">
                    <i class="bi bi-bell"></i>
                    System Alerts
                </h2>
                <div class="dropdown ms-3">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="alertFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="alertFilterDropdown">
                        <li><a class="dropdown-item active" href="#" data-filter="all">All Alerts</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="unacknowledged">Unacknowledged</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="acknowledged">Acknowledged</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-filter="ssl">SSL Certificate</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="domain">Domain Expiry</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="ping">Ping Status</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="error">Errors</a></li>
                    </ul>
                </div>
            </div>
            <div class="header-actions">
                <!-- Acknowledge All button will be added here by JavaScript -->
            </div>
        </div>
        <div class="modern-card-body">
            <div class="alert-timeline">
                {% if alerts %}
                    <!-- Unacknowledged Alerts Section -->
                    {% set has_unacknowledged = false %}
                    <div class="alert-section mb-3" id="unacknowledged-alerts-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="alert-section-title mb-0">
                                <i class="bi bi-bell-fill text-danger me-2"></i>
                                Unacknowledged Alerts
                                <span class="badge bg-danger ms-2" id="unacknowledged-count">0</span>
                            </h3>
                            <div class="bulk-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllUnacknowledgedBtn">
                                    <i class="bi bi-check-square me-1"></i> Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="bulkAcknowledgeBtn" style="display: none;">
                                    <i class="bi bi-check-all me-1"></i> Acknowledge Selected
                                </button>
                            </div>
                        </div>

                        {% for alert in alerts %}
                            {% if not alert.acknowledged %}
                                {% set has_unacknowledged = true %}
                                <div class="timeline-item" data-alert-type="{{ alert.type|lower }}">
                                    <div class="timeline-checkbox">
                                        <div class="form-check">
                                            <input class="form-check-input alert-checkbox" type="checkbox" value="{{ alert.id }}" data-alert-id="{{ alert.id }}">
                                        </div>
                                    </div>
                                    <div class="timeline-icon {{ alert.type|lower }}">
                                        <i class="bi bi-{{ alert.icon }}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <p class="timeline-text mb-0">{{ alert.message }}</p>
                                        </div>
                                        <div class="timeline-meta">
                                            <span class="timeline-time">{{ alert.time }}</span>
                                            <span class="timeline-domain">{{ alert.domain }}</span>
                                        </div>
                                    </div>
                                    <div class="timeline-actions">
                                        <form action="{{ url_for('acknowledge_alert', alert_id=alert.id) }}" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Acknowledge">
                                                <i class="bi bi-check-circle"></i> Acknowledge
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Acknowledged Alerts Section -->
                    {% set has_acknowledged = false %}
                    <div class="alert-section" id="acknowledged-alerts-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="alert-section-title mb-0">
                                <i class="bi bi-bell-check text-secondary me-2"></i>
                                Acknowledged Alerts
                                <span class="badge bg-secondary ms-2" id="acknowledged-count">0</span>
                            </h3>
                            <div class="bulk-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllAcknowledgedBtn">
                                    <i class="bi bi-check-square me-1"></i> Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="bulkUnacknowledgeBtn" style="display: none;">
                                    <i class="bi bi-x-circle me-1"></i> Unacknowledge Selected
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="bulkDeleteBtn" style="display: none;">
                                    <i class="bi bi-trash me-1"></i> Delete Selected
                                </button>
                                <form action="{{ url_for('delete_all_acknowledged_alerts') }}" method="POST" class="d-inline ms-2" id="delete-all-form">
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="delete-all-btn">
                                        <i class="bi bi-trash me-1"></i> Delete All
                                    </button>
                                </form>
                            </div>
                        </div>

                        {% for alert in alerts %}
                            {% if alert.acknowledged %}
                                {% set has_acknowledged = true %}
                                <div class="timeline-item acknowledged" data-alert-type="{{ alert.type|lower }}">
                                    <div class="timeline-checkbox">
                                        <div class="form-check">
                                            <input class="form-check-input acknowledged-alert-checkbox" type="checkbox" value="{{ alert.id }}" data-alert-id="{{ alert.id }}">
                                        </div>
                                    </div>
                                    <div class="timeline-icon {{ alert.type|lower }}">
                                        <i class="bi bi-{{ alert.icon }}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <p class="timeline-text mb-0">{{ alert.message }}</p>
                                        </div>
                                        <div class="timeline-meta">
                                            <span class="timeline-time">{{ alert.time }}</span>
                                            <span class="timeline-domain">{{ alert.domain }}</span>
                                            <span class="badge bg-secondary">Acknowledged</span>
                                        </div>
                                    </div>
                                    <div class="timeline-actions">
                                        <div class="btn-group">
                                            <form action="{{ url_for('unacknowledge_alert', alert_id=alert.id) }}" method="POST" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary" title="Remove acknowledgment">
                                                    <i class="bi bi-x-circle"></i> Unacknowledge
                                                </button>
                                            </form>
                                            <form action="{{ url_for('delete_alert', alert_id=alert.id) }}" method="POST" class="d-inline ms-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-alert-btn" title="Delete alert" data-alert-id="{{ alert.id }}">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <script>
                        // Update the counts and hide empty sections
                        document.addEventListener('DOMContentLoaded', function() {
                            const unacknowledgedItems = document.querySelectorAll('#unacknowledged-alerts-section .timeline-item').length;
                            const acknowledgedItems = document.querySelectorAll('#acknowledged-alerts-section .timeline-item').length;

                            document.getElementById('unacknowledged-count').textContent = unacknowledgedItems;
                            document.getElementById('acknowledged-count').textContent = acknowledgedItems;

                            if (unacknowledgedItems === 0) {
                                document.getElementById('unacknowledged-alerts-section').style.display = 'none';
                            }

                            if (acknowledgedItems === 0) {
                                document.getElementById('acknowledged-alerts-section').style.display = 'none';
                            }

                            // Handle individual alert deletion
                            const deleteButtons = document.querySelectorAll('.delete-alert-btn');
                            deleteButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    const alertId = this.getAttribute('data-alert-id');
                                    if (confirm('Are you sure you want to delete this alert? This action cannot be undone.')) {
                                        this.closest('form').submit();
                                    }
                                });
                            });

                            // Handle delete all acknowledged alerts
                            const deleteAllBtn = document.getElementById('delete-all-btn');
                            if (deleteAllBtn) {
                                deleteAllBtn.addEventListener('click', function() {
                                    if (acknowledgedItems === 0) {
                                        alert('There are no acknowledged alerts to delete.');
                                        return;
                                    }

                                    if (confirm(`Are you sure you want to delete all ${acknowledgedItems} acknowledged alerts? This action cannot be undone.`)) {
                                        document.getElementById('delete-all-form').submit();
                                    }
                                });
                            }

                            // Restore deleted alerts functionality removed
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No alerts to display. All systems are operating normally.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Alert filtering functionality
        const filterLinks = document.querySelectorAll('[data-filter]');
        const alertItems = document.querySelectorAll('.timeline-item');
        const alertSections = document.querySelectorAll('.alert-section');

        // Bulk operations elements
        const selectAllUnacknowledgedBtn = document.getElementById('selectAllUnacknowledgedBtn');
        const selectAllAcknowledgedBtn = document.getElementById('selectAllAcknowledgedBtn');
        const bulkAcknowledgeBtn = document.getElementById('bulkAcknowledgeBtn');
        const bulkUnacknowledgeBtn = document.getElementById('bulkUnacknowledgeBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const alertCheckboxes = document.querySelectorAll('.alert-checkbox');
        const acknowledgedAlertCheckboxes = document.querySelectorAll('.acknowledged-alert-checkbox');

        // Function to update bulk action buttons visibility
        function updateBulkActionButtons() {
            // For unacknowledged alerts
            const checkedUnacknowledged = document.querySelectorAll('.alert-checkbox:checked').length;
            bulkAcknowledgeBtn.style.display = checkedUnacknowledged > 0 ? 'inline-block' : 'none';

            // For acknowledged alerts
            const checkedAcknowledged = document.querySelectorAll('.acknowledged-alert-checkbox:checked').length;
            bulkUnacknowledgeBtn.style.display = checkedAcknowledged > 0 ? 'inline-block' : 'none';
            bulkDeleteBtn.style.display = checkedAcknowledged > 0 ? 'inline-block' : 'none';
        }

        // Select all unacknowledged alerts
        if (selectAllUnacknowledgedBtn) {
            selectAllUnacknowledgedBtn.addEventListener('click', function() {
                const isSelectAll = !this.classList.contains('active');
                this.classList.toggle('active');
                this.innerHTML = isSelectAll ?
                    '<i class="bi bi-square me-1"></i> Deselect All' :
                    '<i class="bi bi-check-square me-1"></i> Select All';

                alertCheckboxes.forEach(checkbox => {
                    checkbox.checked = isSelectAll;
                });

                updateBulkActionButtons();
            });
        }

        // Select all acknowledged alerts
        if (selectAllAcknowledgedBtn) {
            selectAllAcknowledgedBtn.addEventListener('click', function() {
                const isSelectAll = !this.classList.contains('active');
                this.classList.toggle('active');
                this.innerHTML = isSelectAll ?
                    '<i class="bi bi-square me-1"></i> Deselect All' :
                    '<i class="bi bi-check-square me-1"></i> Select All';

                acknowledgedAlertCheckboxes.forEach(checkbox => {
                    checkbox.checked = isSelectAll;
                });

                updateBulkActionButtons();
            });
        }

        // Individual checkbox change events
        alertCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActionButtons);
        });

        acknowledgedAlertCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActionButtons);
        });

        // Bulk acknowledge button
        if (bulkAcknowledgeBtn) {
            bulkAcknowledgeBtn.addEventListener('click', function() {
                const selectedAlerts = Array.from(document.querySelectorAll('.alert-checkbox:checked')).map(cb => cb.value);

                if (selectedAlerts.length === 0) {
                    alert('Please select at least one alert to acknowledge.');
                    return;
                }

                if (confirm(`Are you sure you want to acknowledge ${selectedAlerts.length} selected alert(s)?`)) {
                    // Create a form to submit all at once
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("bulk_acknowledge_alerts") }}';

                    // Add all selected alert IDs as hidden inputs
                    selectedAlerts.forEach(alertId => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'alert_ids';
                        input.value = alertId;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Bulk unacknowledge button
        if (bulkUnacknowledgeBtn) {
            bulkUnacknowledgeBtn.addEventListener('click', function() {
                const selectedAlerts = Array.from(document.querySelectorAll('.acknowledged-alert-checkbox:checked')).map(cb => cb.value);

                if (selectedAlerts.length === 0) {
                    alert('Please select at least one alert to unacknowledge.');
                    return;
                }

                if (confirm(`Are you sure you want to unacknowledge ${selectedAlerts.length} selected alert(s)?`)) {
                    // Create a form to submit all at once
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("bulk_unacknowledge_alerts") }}';

                    // Add all selected alert IDs as hidden inputs
                    selectedAlerts.forEach(alertId => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'alert_ids';
                        input.value = alertId;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Bulk delete button
        if (bulkDeleteBtn) {
            bulkDeleteBtn.addEventListener('click', function() {
                const selectedAlerts = Array.from(document.querySelectorAll('.acknowledged-alert-checkbox:checked')).map(cb => cb.value);

                if (selectedAlerts.length === 0) {
                    alert('Please select at least one alert to delete.');
                    return;
                }

                if (confirm(`Are you sure you want to delete ${selectedAlerts.length} selected alert(s)? This action cannot be undone.`)) {
                    // Create a form to submit all at once
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("bulk_delete_alerts") }}';

                    // Add all selected alert IDs as hidden inputs
                    selectedAlerts.forEach(alertId => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'alert_ids';
                        input.value = alertId;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Alert filtering functionality
        filterLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // Update active state
                filterLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const filterValue = this.getAttribute('data-filter');

                // Show/hide alerts based on filter
                alertItems.forEach(item => {
                    const isAcknowledged = item.classList.contains('acknowledged');
                    const alertType = item.getAttribute('data-alert-type');

                    let shouldShow = false;

                    if (filterValue === 'all') {
                        shouldShow = true;
                    } else if (filterValue === 'acknowledged') {
                        shouldShow = isAcknowledged;
                    } else if (filterValue === 'unacknowledged') {
                        shouldShow = !isAcknowledged;
                    } else {
                        shouldShow = alertType === filterValue;
                    }

                    item.style.display = shouldShow ? '' : 'none';
                });

                // Show/hide sections based on visible alerts
                alertSections.forEach(section => {
                    const visibleAlertsInSection = section.querySelectorAll('.timeline-item:not([style*="display: none"])');
                    if (visibleAlertsInSection.length > 0) {
                        section.style.display = '';
                        // Update the count badge
                        const countBadge = section.querySelector('.badge');
                        if (countBadge) {
                            countBadge.textContent = visibleAlertsInSection.length;
                        }
                    } else {
                        section.style.display = 'none';
                    }
                });

                // Show message if no alerts match filter
                const visibleAlerts = Array.from(alertItems).filter(item => item.style.display !== 'none');
                let noAlertsMessage = document.querySelector('.alert-info');
                const noFilterMatchMessage = document.querySelector('.no-filter-match');

                if (visibleAlerts.length === 0) {
                    if (noAlertsMessage) {
                        noAlertsMessage.style.display = 'none';
                    }

                    if (!noFilterMatchMessage) {
                        const message = document.createElement('div');
                        message.className = 'alert alert-info mt-3 no-filter-match';
                        message.innerHTML = '<i class="bi bi-info-circle me-2"></i> No alerts match the selected filter.';
                        document.querySelector('.alert-timeline').appendChild(message);
                    } else {
                        noFilterMatchMessage.style.display = '';
                    }
                } else {
                    if (noFilterMatchMessage) {
                        noFilterMatchMessage.style.display = 'none';
                    }
                }

                // Reset checkboxes when filtering
                document.querySelectorAll('.form-check-input').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Reset select all buttons
                if (selectAllUnacknowledgedBtn) {
                    selectAllUnacknowledgedBtn.classList.remove('active');
                    selectAllUnacknowledgedBtn.innerHTML = '<i class="bi bi-check-square me-1"></i> Select All';
                }

                if (selectAllAcknowledgedBtn) {
                    selectAllAcknowledgedBtn.classList.remove('active');
                    selectAllAcknowledgedBtn.innerHTML = '<i class="bi bi-check-square me-1"></i> Select All';
                }

                // Update bulk action buttons
                updateBulkActionButtons();
            });
        });

        // Delete all acknowledged alerts button
        const deleteAllBtn = document.getElementById('delete-all-btn');
        if (deleteAllBtn) {
            deleteAllBtn.addEventListener('click', function() {
                const acknowledgedItems = document.querySelectorAll('#acknowledged-alerts-section .timeline-item').length;
                if (acknowledgedItems === 0) {
                    alert('There are no acknowledged alerts to delete.');
                    return;
                }

                if (confirm(`Are you sure you want to delete all ${acknowledgedItems} acknowledged alerts? This action cannot be undone.`)) {
                    document.getElementById('delete-all-form').submit();
                }
            });
        }
    });
</script>
{% endblock %}
