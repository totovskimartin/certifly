{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    .toggle-label {
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 24px;
        display: inline-block;
    }

    .form-check-input:checked ~ .toggle-label {
        color: var(--bs-primary);
    }

    .form-check-input:not(:checked) ~ .toggle-label {
        color: var(--bs-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Notification Settings</h1>
            <p class="dashboard-subtitle">Configure how you want to be notified about certificate and domain expiry alerts.</p>
        </div>
    </div>

    <div class="dashboard-main-content">
        <div class="modern-card">
            <div class="modern-card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    The warning threshold for certificate and domain expiry notifications is configured in the <a href="{{ url_for('app_settings') }}">General Settings</a> page.
                </div>

                <!-- Daily Summary Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-envelope-check me-2"></i>
                            Daily Summary Email
                        </h5>
                        <p class="card-text">
                            The system automatically sends a daily summary email at 8:00 AM with all domain warnings and errors if email notifications are enabled.
                            You can also manually trigger a summary check and email using the button below.
                        </p>
                        <form action="{{ url_for('manual_check_and_send_summary') }}" method="POST">
                            <button type="submit" class="btn btn-primary" {% if not notifications.email.enabled %}disabled{% endif %}>
                                <i class="bi bi-envelope-paper me-1"></i> Send Summary Email Now
                            </button>
                            {% if not notifications.email.enabled %}
                            <div class="text-muted mt-2">
                                <small><i class="bi bi-info-circle me-1"></i> Email notifications must be enabled to send summary emails.</small>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>

                <!-- Notification Channels Accordion -->
                <div class="accordion" id="notificationAccordion" data-bs-parent="">
                    <!-- Email Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#emailCollapse"
                                    aria-expanded="false"
                                    aria-controls="emailCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope me-2"></i>
                                    <span>Email Notifications</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="emailEnabled"
                                               {% if notifications.email.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('email', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.email.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="emailCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="emailForm">
                                    <input type="hidden" name="notification_type" value="email">
                                    <input type="hidden" name="enabled" value="{% if notifications.email.enabled %}true{% else %}false{% endif %}" id="emailEnabledInput">

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="smtp_server" class="form-label">SMTP Server</label>
                                            <input type="text" class="form-control" id="smtp_server" name="smtp_server"
                                                   value="{{ notifications.email.smtp_server }}"
                                                   placeholder="smtp.office365.com"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="smtp_port" class="form-label">SMTP Port</label>
                                            <input type="text" class="form-control" id="smtp_port" name="smtp_port"
                                                   value="{{ notifications.email.smtp_port }}"
                                                   placeholder="587"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="smtp_username" class="form-label">SMTP Username</label>
                                            <input type="text" class="form-control" id="smtp_username" name="smtp_username"
                                                   value="{{ notifications.email.smtp_username }}"
                                                   placeholder="your.email@example.com"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="smtp_password" class="form-label">SMTP Password</label>
                                            <input type="password" class="form-control" id="smtp_password" name="smtp_password"
                                                   value="{{ notifications.email.smtp_password }}"
                                                   placeholder="Your email password"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                            <div class="form-text">Leave blank to keep the existing password</div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="from_email" class="form-label">From Email Address</label>
                                            <input type="email" class="form-control" id="from_email" name="from_email"
                                                   value="{{ notifications.email.from_email }}"
                                                   placeholder="sender@example.com"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                            <div class="form-text">
                                                The email address that will appear in the "From" field. If left blank, it will be constructed from the SMTP username.
                                                <strong>Note for SendGrid users:</strong> This must be a verified sender in your SendGrid account.
                                                <a href="https://sendgrid.com/docs/for-developers/sending-email/sender-identity/" target="_blank">Learn more</a>
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="notification_email" class="form-label">Recipient Email</label>
                                            <input type="email" class="form-control" id="notification_email" name="notification_email"
                                                   value="{{ notifications.email.notification_email }}"
                                                   placeholder="recipient@example.com"
                                                   {% if not notifications.email.enabled %}disabled{% endif %}>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.email.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Email Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('email')" {% if not notifications.email.enabled %}disabled{% endif %}>
                                            <i class="bi bi-envelope-check me-1"></i> Test Email
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Microsoft Teams Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#teamsCollapse"
                                    aria-expanded="false"
                                    aria-controls="teamsCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-microsoft-teams me-2"></i>
                                    <span>Microsoft Teams</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="teamsEnabled"
                                               {% if notifications.teams.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('teams', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.teams.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="teamsCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="teamsForm">
                                    <input type="hidden" name="notification_type" value="teams">
                                    <input type="hidden" name="enabled" value="{% if notifications.teams.enabled %}true{% else %}false{% endif %}" id="teamsEnabledInput">

                                    <div class="mb-3">
                                        <label for="teams_webhook_url" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="teams_webhook_url" name="webhook_url"
                                               value="{{ notifications.teams.webhook_url }}"
                                               placeholder="https://outlook.office.com/webhook/..."
                                               {% if not notifications.teams.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the webhook URL for your Microsoft Teams channel.
                                            <a href="https://docs.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook" target="_blank">
                                                Learn how to create a webhook
                                            </a>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.teams.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Teams Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('teams')" {% if not notifications.teams.enabled %}disabled{% endif %}>
                                            <i class="bi bi-microsoft-teams me-1"></i> Test Teams Notification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Slack Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#slackCollapse"
                                    aria-expanded="false"
                                    aria-controls="slackCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-slack me-2"></i>
                                    <span>Slack</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="slackEnabled"
                                               {% if notifications.slack.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('slack', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.slack.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="slackCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="slackForm">
                                    <input type="hidden" name="notification_type" value="slack">
                                    <input type="hidden" name="enabled" value="{% if notifications.slack.enabled %}true{% else %}false{% endif %}" id="slackEnabledInput">

                                    <div class="mb-3">
                                        <label for="slack_webhook_url" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="slack_webhook_url" name="webhook_url"
                                               value="{{ notifications.slack.webhook_url }}"
                                               placeholder="https://hooks.slack.com/services/..."
                                               {% if not notifications.slack.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the webhook URL for your Slack channel.
                                            <a href="https://api.slack.com/messaging/webhooks" target="_blank">
                                                Learn how to create a webhook
                                            </a>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="slack_channel" class="form-label">Channel (Optional)</label>
                                        <input type="text" class="form-control" id="slack_channel" name="channel"
                                               value="{{ notifications.slack.channel }}"
                                               placeholder="#alerts"
                                               {% if not notifications.slack.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the channel name (e.g., #alerts). Leave blank to use the webhook's default channel.
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.slack.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Slack Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('slack')" {% if not notifications.slack.enabled %}disabled{% endif %}>
                                            <i class="bi bi-slack me-1"></i> Test Slack Notification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Discord Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#discordCollapse"
                                    aria-expanded="false"
                                    aria-controls="discordCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-discord me-2"></i>
                                    <span>Discord</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="discordEnabled"
                                               {% if notifications.discord.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('discord', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.discord.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="discordCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="discordForm">
                                    <input type="hidden" name="notification_type" value="discord">
                                    <input type="hidden" name="enabled" value="{% if notifications.discord.enabled %}true{% else %}false{% endif %}" id="discordEnabledInput">

                                    <div class="mb-3">
                                        <label for="discord_webhook_url" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="discord_webhook_url" name="webhook_url"
                                               value="{{ notifications.discord.webhook_url }}"
                                               placeholder="https://discord.com/api/webhooks/..."
                                               {% if not notifications.discord.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the webhook URL for your Discord channel.
                                            <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks" target="_blank">
                                                Learn how to create a webhook
                                            </a>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="discord_username" class="form-label">Bot Username (Optional)</label>
                                        <input type="text" class="form-control" id="discord_username" name="username"
                                               value="{{ notifications.discord.username }}"
                                               placeholder="Certifly Bot"
                                               {% if not notifications.discord.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Custom username for the webhook bot. Leave blank to use the default.
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.discord.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Discord Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('discord')" {% if not notifications.discord.enabled %}disabled{% endif %}>
                                            <i class="bi bi-discord me-1"></i> Test Discord Notification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Telegram Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#telegramCollapse"
                                    aria-expanded="false"
                                    aria-controls="telegramCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-telegram me-2"></i>
                                    <span>Telegram</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="telegramEnabled"
                                               {% if notifications.telegram.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('telegram', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.telegram.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="telegramCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="telegramForm">
                                    <input type="hidden" name="notification_type" value="telegram">
                                    <input type="hidden" name="enabled" value="{% if notifications.telegram.enabled %}true{% else %}false{% endif %}" id="telegramEnabledInput">

                                    <div class="mb-3">
                                        <label for="telegram_bot_token" class="form-label">Bot Token</label>
                                        <input type="text" class="form-control" id="telegram_bot_token" name="bot_token"
                                               value="{{ notifications.telegram.bot_token }}"
                                               placeholder="1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZ"
                                               {% if not notifications.telegram.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter your Telegram bot token. You can create a bot using BotFather.
                                            <a href="https://core.telegram.org/bots#how-do-i-create-a-bot" target="_blank">
                                                Learn how to create a Telegram bot
                                            </a>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                        <input type="text" class="form-control" id="telegram_chat_id" name="chat_id"
                                               value="{{ notifications.telegram.chat_id }}"
                                               placeholder="-1001234567890"
                                               {% if not notifications.telegram.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the chat ID where notifications should be sent. This can be a group chat ID or your personal chat ID.
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.telegram.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Telegram Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('telegram')" {% if not notifications.telegram.enabled %}disabled{% endif %}>
                                            <i class="bi bi-telegram me-1"></i> Test Telegram Notification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Webhook Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#webhookCollapse"
                                    aria-expanded="false"
                                    aria-controls="webhookCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-link-45deg me-2"></i>
                                    <span>Custom Webhook</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="webhookEnabled"
                                               {% if notifications.webhook.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('webhook', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.webhook.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="webhookCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="webhookForm">
                                    <input type="hidden" name="notification_type" value="webhook">
                                    <input type="hidden" name="enabled" value="{% if notifications.webhook.enabled %}true{% else %}false{% endif %}" id="webhookEnabledInput">

                                    <div class="mb-3">
                                        <label for="webhook_url" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="webhook_url" name="webhook_url"
                                               value="{{ notifications.webhook.webhook_url }}"
                                               placeholder="https://example.com/webhook"
                                               {% if not notifications.webhook.enabled %}disabled{% endif %}>
                                        <div class="form-text">
                                            Enter the URL where webhook notifications should be sent.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="webhook_format" class="form-label">Format</label>
                                        <select class="form-select" id="webhook_format" name="format"
                                                {% if not notifications.webhook.enabled %}disabled{% endif %}>
                                            <option value="json" {% if notifications.webhook.format == 'json' %}selected{% endif %}>JSON</option>
                                        </select>
                                        <div class="form-text">
                                            Select the format for webhook payloads.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="webhook_custom_headers" class="form-label">Custom Headers (JSON)</label>
                                        <textarea class="form-control" id="webhook_custom_headers" name="custom_headers" rows="3"
                                                  placeholder='{"Authorization": "Bearer token123", "Content-Type": "application/json"}'
                                                  {% if not notifications.webhook.enabled %}disabled{% endif %}>{{ notifications.webhook.custom_headers }}</textarea>
                                        <div class="form-text">
                                            Enter custom headers as a JSON object, e.g., {"Authorization": "Bearer token123"}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="webhook_custom_fields" class="form-label">Custom Fields (JSON)</label>
                                        <textarea class="form-control" id="webhook_custom_fields" name="custom_fields" rows="3"
                                                  placeholder='{"source": "certifly", "priority": "high", "environment": "production"}'
                                                  {% if not notifications.webhook.enabled %}disabled{% endif %}>{{ notifications.webhook.custom_fields }}</textarea>
                                        <div class="form-text">
                                            Enter custom fields to include in the payload as a JSON object, e.g., {"source": "certifly", "priority": "high"}
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.webhook.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save Webhook Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('webhook')" {% if not notifications.webhook.enabled %}disabled{% endif %}>
                                            <i class="bi bi-link-45deg me-1"></i> Test Webhook
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- SMS Notifications -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between align-items-center"
                                    type="button"
                                    data-bs-target="#smsCollapse"
                                    aria-expanded="false"
                                    aria-controls="smsCollapse">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-phone me-2"></i>
                                    <span>SMS (Twilio)</span>
                                    <div class="form-check form-switch ms-2" onclick="event.stopPropagation();">
                                        <input class="form-check-input" type="checkbox" id="smsEnabled"
                                               {% if notifications.sms.enabled %}checked{% endif %}
                                               onchange="toggleNotificationSection('sms', this.checked);">
                                        <span class="toggle-label ms-1">{{ 'On' if notifications.sms.enabled else 'Off' }}</span>
                                    </div>
                                </div>
                                <div></div>
                            </button>
                        </h2>
                        <div id="smsCollapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <form action="{{ url_for('save_notifications') }}" method="POST" id="smsForm">
                                    <input type="hidden" name="notification_type" value="sms">
                                    <input type="hidden" name="enabled" value="{% if notifications.sms.enabled %}true{% else %}false{% endif %}" id="smsEnabledInput">

                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        SMS notifications require a Twilio account. The Twilio Python package must be installed on the server.
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="sms_account_sid" class="form-label">Twilio Account SID</label>
                                            <input type="text" class="form-control" id="sms_account_sid" name="account_sid"
                                                   value="{{ notifications.sms.account_sid }}"
                                                   placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                                   {% if not notifications.sms.enabled %}disabled{% endif %}>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="sms_auth_token" class="form-label">Twilio Auth Token</label>
                                            <input type="password" class="form-control" id="sms_auth_token" name="auth_token"
                                                   value="{{ notifications.sms.auth_token }}"
                                                   placeholder="your_auth_token"
                                                   {% if not notifications.sms.enabled %}disabled{% endif %}>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="sms_from_number" class="form-label">From Number</label>
                                            <input type="text" class="form-control" id="sms_from_number" name="from_number"
                                                   value="{{ notifications.sms.from_number }}"
                                                   placeholder="+1234567890"
                                                   {% if not notifications.sms.enabled %}disabled{% endif %}>
                                            <div class="form-text">
                                                Your Twilio phone number in E.164 format (e.g., +1234567890)
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="sms_to_number" class="form-label">To Number</label>
                                            <input type="text" class="form-control" id="sms_to_number" name="to_number"
                                                   value="{{ notifications.sms.to_number }}"
                                                   placeholder="+1234567890"
                                                   {% if not notifications.sms.enabled %}disabled{% endif %}>
                                            <div class="form-text">
                                                The recipient's phone number in E.164 format (e.g., +1234567890)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" {% if not notifications.sms.enabled %}disabled{% endif %}>
                                            <i class="bi bi-save me-1"></i> Save SMS Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testNotification('sms')" {% if not notifications.sms.enabled %}disabled{% endif %}>
                                            <i class="bi bi-phone me-1"></i> Test SMS
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Notification Modal -->
<div class="modal fade" id="testNotificationModal" tabindex="-1" aria-labelledby="testNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testNotificationModalLabel">Test Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Send a test notification to verify your settings?</p>
                <form id="testNotificationForm" action="{{ url_for('test_notification') }}" method="POST">
                    <input type="hidden" name="notification_type" id="testNotificationType" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="testNotificationForm" class="btn btn-primary">Send Test</button>
            </div>
        </div>
    </div>
</div>

<script>
    // This function will be called when a toggle switch is clicked
    function toggleNotificationSection(type, enabled) {
        console.log(`Toggle ${type} to ${enabled}`);

        // Update the hidden input
        document.getElementById(type + 'EnabledInput').value = enabled ? 'true' : 'false';

        // Enable/disable form fields
        const form = document.getElementById(type + 'Form');
        const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea, button');
        inputs.forEach(input => {
            input.disabled = !enabled;
        });

        // Update the toggle label
        const toggleSwitch = document.getElementById(type + 'Enabled');
        const toggleLabel = toggleSwitch.nextElementSibling;
        if (toggleLabel && toggleLabel.classList.contains('toggle-label')) {
            toggleLabel.textContent = enabled ? 'On' : 'Off';
        }

        // Get the collapse element
        const collapseElement = document.getElementById(type + 'Collapse');

        // If turning on and the section is collapsed, open it
        // Otherwise, don't change the state
        if (enabled && !collapseElement.classList.contains('show')) {
            // We need to manually show the collapse without using Bootstrap's collapse
            // to avoid the default accordion behavior
            collapseElement.classList.add('show');
        }
    }

    function testNotification(type) {
        // Set the notification type in the modal form
        document.getElementById('testNotificationType').value = type;

        // Update modal title based on notification type
        let title = 'Test ';
        switch(type) {
            case 'email':
                title += 'Email';
                break;
            case 'teams':
                title += 'Microsoft Teams';
                break;
            case 'slack':
                title += 'Slack';
                break;
            case 'discord':
                title += 'Discord';
                break;
            case 'telegram':
                title += 'Telegram';
                break;
            case 'webhook':
                title += 'Webhook';
                break;
            case 'sms':
                title += 'SMS';
                break;
        }
        document.getElementById('testNotificationModalLabel').textContent = title + ' Notification';

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Completely disable the accordion behavior for the toggle switches
        document.querySelectorAll('.form-check-input').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Prevent the form-switch container from toggling the accordion
        document.querySelectorAll('.form-switch').forEach(switchEl => {
            switchEl.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Modify the accordion buttons to not toggle when the toggle switch is clicked
        document.querySelectorAll('.accordion-button').forEach(button => {
            // Remove the data-bs-toggle attribute to prevent Bootstrap's default behavior
            button.setAttribute('data-original-toggle', button.getAttribute('data-bs-toggle'));
            button.removeAttribute('data-bs-toggle');

            // Add our own click handler
            button.addEventListener('click', function(e) {
                // Only toggle if the click didn't come from the toggle switch
                if (!e.target.classList.contains('form-check-input') &&
                    !e.target.closest('.form-switch')) {
                    const targetId = this.getAttribute('data-bs-target');
                    const targetElement = document.querySelector(targetId);

                    if (targetElement) {
                        if (targetElement.classList.contains('show')) {
                            targetElement.classList.remove('show');
                            this.classList.add('collapsed');
                            this.setAttribute('aria-expanded', 'false');
                        } else {
                            targetElement.classList.add('show');
                            this.classList.remove('collapsed');
                            this.setAttribute('aria-expanded', 'true');
                        }
                    }
                }
            });
        });
    });
</script>
{% endblock %}
