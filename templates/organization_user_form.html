{% extends "base.html" %}

{% block content %}
<div class="container py-3">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h1 class="h4 mb-0">{{ title|replace('User', 'Member') }}</h1>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('add_organization_user', org_id=organization.id) }}">
                        <div class="mb-4">
                            <label for="username" class="form-label">Find User</label>
                            <div class="user-search-container">
                                <div class="user-search-input-group">
                                    <span class="search-icon">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control user-search-input" id="username" name="username" placeholder="Search by username..." autocomplete="off" required>
                                    <button type="button" class="search-clear-btn" id="clearSearch" style="display: none;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <span class="status-indicator" id="username-status">
                                        <i class="bi bi-question-circle text-muted"></i>
                                    </span>
                                </div>
                                <div class="user-suggestions" id="userSuggestions"></div>
                            </div>
                            <div class="form-text mt-2" id="username-feedback">Search for an existing user to add as a member to this organization.</div>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role" name="role">
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                            </select>
                            <div class="form-text">
                                <strong>Member:</strong> Can view and manage domains within the organization.<br>
                                <strong>Admin:</strong> Can manage organization settings, users, and domains.
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('organization_users', org_id=organization.id) }}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Add Member</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usernameInput = document.getElementById('username');
        const usernameStatus = document.getElementById('username-status');
        const usernameFeedback = document.getElementById('username-feedback');
        const submitButton = document.querySelector('button[type="submit"]');
        const userSuggestions = document.getElementById('userSuggestions');
        const clearSearchBtn = document.getElementById('clearSearch');

        let selectedUser = null;

        // Debounce function to limit API calls
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Function to clear search
        function clearSearch() {
            usernameInput.value = '';
            userSuggestions.innerHTML = '';
            userSuggestions.style.display = 'none';
            clearSearchBtn.style.display = 'none';
            usernameStatus.innerHTML = '<i class="bi bi-question-circle text-muted"></i>';
            usernameFeedback.textContent = 'Search for an existing user to add as a member to this organization.';
            usernameFeedback.className = 'form-text';
            submitButton.disabled = true;
            selectedUser = null;
        }

        // Add event listener to clear search button
        clearSearchBtn.addEventListener('click', clearSearch);

        // Function to fetch user suggestions
        const fetchUserSuggestions = debounce(function(query) {
            // Show/hide clear button based on input
            clearSearchBtn.style.display = query ? 'flex' : 'none';

            if (!query || query.length < 2) {
                userSuggestions.innerHTML = '';
                userSuggestions.style.display = 'none';
                return;
            }

            // Get the organization ID from the URL
            const urlParts = window.location.pathname.split('/');
            console.log('URL parts:', urlParts);

            // Extract org_id from URL path
            let orgId;
            if (urlParts.length >= 3) {
                orgId = urlParts[2];
                console.log('Extracted org_id from URL:', orgId);
            } else {
                console.error('Could not extract org_id from URL path:', window.location.pathname);
                orgId = '{{ org_id }}'; // Fallback to server-side value
                console.log('Using server-side org_id:', orgId);
            }

            // Show loading in suggestions
            userSuggestions.innerHTML = '<div class="user-suggestion-loading"><i class="bi bi-hourglass-split"></i> Searching...</div>';
            userSuggestions.style.display = 'block';

            console.log(`Fetching suggestions for query: ${query}, org_id: ${orgId}`);

            // Log the full URL for debugging
            const apiUrl = `/api/get_user_suggestions?query=${encodeURIComponent(query)}&org_id=${orgId}`;
            console.log('API URL:', apiUrl);

            // Call API to get user suggestions
            fetch(apiUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    return response.json();
                })
                .catch(error => {
                    console.error('Error parsing JSON response:', error);
                    return { success: false, error: 'Failed to parse response' };
                })
                .then(data => {
                    console.log('API response data:', data);
                    if (data && data.success) {
                        // Clear existing options
                        userSuggestions.innerHTML = '';

                        if (!data.suggestions || data.suggestions.length === 0) {
                            userSuggestions.innerHTML = '<div class="user-suggestion-empty">No users found</div>';
                            userSuggestions.style.display = 'block';
                            return;
                        }

                        // Add new options
                        data.suggestions.forEach(username => {
                            console.log('Adding suggestion:', username);
                            const suggestionItem = document.createElement('div');
                            suggestionItem.className = 'user-suggestion-item';
                            suggestionItem.innerHTML = `
                                <div class="user-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${username}</div>
                                </div>
                            `;

                            // Add click event to select user
                            suggestionItem.addEventListener('click', function() {
                                usernameInput.value = username;
                                userSuggestions.style.display = 'none';
                                checkUserExists(username);
                                selectedUser = username;
                            });

                            userSuggestions.appendChild(suggestionItem);
                        });

                        userSuggestions.style.display = 'block';
                    } else {
                        userSuggestions.innerHTML = '<div class="user-suggestion-error">Error loading suggestions</div>';
                        userSuggestions.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching user suggestions:', error);
                    userSuggestions.innerHTML = '<div class="user-suggestion-error">Error loading suggestions</div>';
                    userSuggestions.style.display = 'block';

                    // Try to create a test user for debugging
                    console.log('Attempting to debug user suggestions...');
                    fetch('/api/debug_user_suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: query,
                            org_id: orgId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Debug response:', data);
                    })
                    .catch(debugError => {
                        console.error('Debug error:', debugError);
                    });
                });
        }, 300);

        // Function to check if user exists
        const checkUserExists = debounce(function(username) {
            if (!username) {
                usernameStatus.innerHTML = '<i class="bi bi-question-circle text-muted"></i>';
                usernameFeedback.textContent = 'Search for an existing user to add as a member to this organization.';
                usernameFeedback.className = 'form-text';
                submitButton.disabled = true;
                return;
            }

            // Show loading indicator
            usernameStatus.innerHTML = '<i class="bi bi-hourglass-split text-muted"></i>';
            usernameFeedback.textContent = 'Checking username...';

            // Call API to check if user exists
            fetch(`/api/check_user_exists?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        usernameStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                        usernameFeedback.textContent = 'User found! You can add this user to the organization.';
                        usernameFeedback.className = 'form-text text-success';
                        submitButton.disabled = false;
                    } else {
                        usernameStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
                        usernameFeedback.textContent = 'User not found. Please check the username and try again.';
                        usernameFeedback.className = 'form-text text-danger';
                        submitButton.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error checking username:', error);
                    usernameStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
                    usernameFeedback.textContent = 'Error checking username. Please try again.';
                    usernameFeedback.className = 'form-text text-warning';
                    submitButton.disabled = true;
                });
        }, 300);

        // Add event listener to username input
        usernameInput.addEventListener('input', function() {
            const value = this.value.trim();
            fetchUserSuggestions(value);

            // Only check if user exists when typing stops
            if (value !== selectedUser) {
                selectedUser = null;
                checkUserExists(value);
            }
        });

        // Add event listener to document to close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.user-search-container')) {
                userSuggestions.style.display = 'none';
            }
        });

        // Disable submit button by default
        submitButton.disabled = true;
    });
</script>
{% endblock %}
